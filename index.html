<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login / Daftar â€” FoodOrder</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    /* Error toast styling */
    #toast.error {
      background-color: #dc2626; /* Bright red */
      color: white;
      font-weight: bold;
      font-size: 1rem;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen">
  <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
    <h1 class="text-2xl font-bold text-center mb-4">FoodOrder</h1>
    <p class="text-sm text-gray-500 text-center mb-6">Login atau daftar untuk memesan makanan favoritmu.</p>
    <!-- Login Form -->
    <div id="login-form" class="">
      <h2 class="text-lg font-semibold mb-4">Login</h2>
      <form onsubmit="event.preventDefault(); handleLogin();">
        <div class="mb-4">
          <label class="text-xs text-gray-600">Email</label>
          <input id="login-email" type="email" required placeholder="Email anda" class="w-full border border-gray-200 rounded-md px-3 py-2 mt-1 text-sm" />
        </div>
        <div class="mb-4">
          <label class="text-xs text-gray-600">Password</label>
          <input id="login-password" type="password" required placeholder="Password" class="w-full border border-gray-200 rounded-md px-3 py-2 mt-1 text-sm" />
        </div>
        <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded-md mb-2">Login</button>
        <button type="button" onclick="toggleForm()" class="w-full border border-gray-200 py-2 rounded-md">Belum punya akun? Daftar</button>
      </form>
    </div>
    <!-- Signup Form -->
    <div id="signup-form" class="hidden">
      <h2 class="text-lg font-semibold mb-4">Daftar</h2>
      <form onsubmit="event.preventDefault(); handleSignup();">
        <div class="mb-4">
          <label class="text-xs text-gray-600">Nama Lengkap</label>
          <input id="signup-name" type="text" required placeholder="Nama lengkap" class="w-full border border-gray-200 rounded-md px-3 py-2 mt-1 text-sm" />
        </div>
        <div class="mb-4">
          <label class="text-xs text-gray-600">Email</label>
          <input id="signup-email" type="email" required placeholder="Email anda" class="w-full border border-gray-200 rounded-md px-3 py-2 mt-1 text-sm" />
        </div>
        <div class="mb-4">
          <label class="text-xs text-gray-600">Nomor HP</label>
          <input id="signup-phone" type="tel" required placeholder="0812xxxx" class="w-full border border-gray-200 rounded-md px-3 py-2 mt-1 text-sm" />
        </div>
        <div class="mb-4">
          <label class="text-xs text-gray-600">Password</label>
          <input id="signup-password" type="password" required placeholder="Password (min 6 karakter)" class="w-full border border-gray-200 rounded-md px-3 py-2 mt-1 text-sm" />
        </div>
        <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded-md mb-2">Daftar</button>
        <button type="button" onclick="toggleForm()" class="w-full border border-gray-200 py-2 rounded-md">Sudah punya akun? Login</button>
      </form>
    </div>
    <!-- Toast -->
    <div id="toast" class="fixed hidden bg-black text-white text-sm px-4 py-2 rounded-md shadow-lg z-50"></div>
  </div>
  <script>
    const SUPABASE_URL = "https://dlnenwglsmfyhdysmqdc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsbmVud2dsc21meWhkeXNtcWRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTM5ODIsImV4cCI6MjA3MTY4OTk4Mn0.oWKClbQFN5RDS_MkFkPFbwel-LBmD8iGJX1KxN3Db0U";
    if (!SUPABASE_URL || !SUPABASE_ANON) {
      showErrorToast("Konfigurasi Supabase tidak lengkap. Hubungi admin.");
      throw new Error("Supabase credential belum diisi.");
    }
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    function showToast(text, ms = 2500, isError = false) {
      const t = document.getElementById("toast");
      t.innerText = text;
      t.classList.remove("hidden", "error");
      if (isError) {
        t.classList.add("error");
        ms = 3500;
      }
      setTimeout(() => t.classList.add("hidden"), ms);
    }
    function showErrorToast(text) {
      showToast(text, 3500, true);
    }
    function toggleForm() {
      try {
        const loginForm = document.getElementById("login-form");
        const signupForm = document.getElementById("signup-form");
        if (loginForm.classList.contains("hidden")) {
          loginForm.classList.remove("hidden");
          signupForm.classList.add("hidden");
        } else {
          loginForm.classList.add("hidden");
          signupForm.classList.remove("hidden");
        }
      } catch (e) {
        showErrorToast("Gagal mengganti formulir.");
        console.error("toggleForm failed", e);
      }
    }
    async function handleLogin() {
      try {
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value.trim();
        if (!email || !password) {
          showErrorToast("Email dan password wajib diisi.");
          return;
        }
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });
        if (error) {
          showErrorToast("Login gagal: " + error.message);
          return;
        }
        if (data.user) {
          showToast("Login berhasil, mengarahkan kembali...");
          setTimeout(() => window.location.href = "index.html", 1500);
        }
      } catch (e) {
        showErrorToast("Gagal melakukan login. Coba lagi.");
        console.error("handleLogin failed", e);
      }
    }
    async function handleSignup() {
      try {
        const name = document.getElementById("signup-name").value.trim();
        const email = document.getElementById("signup-email").value.trim();
        const phone = document.getElementById("signup-phone").value.trim();
        const password = document.getElementById("signup-password").value.trim();
        if (!name || !email || !phone || !password) {
          showErrorToast("Semua kolom wajib diisi.");
          return;
        }
        if (password.length < 6) {
          showErrorToast("Password minimal 6 karakter.");
          return;
        }
        if (!phone.match(/^(\+62|62|0)\d{9,12}$/)) {
          showErrorToast("Nomor HP tidak valid. Gunakan format 0812xxxx.");
          return;
        }
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: name,
              phone
            }
          }
        });
        if (error) {
          showErrorToast("Pendaftaran gagal: " + error.message);
          return;
        }
        if (data.user) {
          showToast("Pendaftaran berhasil, mengarahkan kembali...");
          setTimeout(() => window.location.href = "index.html", 1500);
        }
      } catch (e) {
        showErrorToast("Gagal melakukan pendaftaran. Coba lagi.");
        console.error("handleSignup failed", e);
      }
    }
    // Check if user is already logged in
    async function checkAuth() {
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error) {
          showErrorToast("Gagal memeriksa sesi login.");
          console.error("Check auth failed", error);
          return;
        }
        if (user) {
          showToast("Sesi login ditemukan, mengarahkan kembali...");
          setTimeout(() => window.location.href = "index.html", 1500);
        }
      } catch (e) {
        showErrorToast("Gagal memeriksa sesi login.");
        console.error("checkAuth failed", e);
      }
    }
    checkAuth();
  </script>
</body>
</html>
