<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERACODING.COM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .auth-container {
            min-height: 100vh;
            background: #FFFF;
        }
        .dashboard-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .avatar-default {
            background: #2563EA;
        }
        .verified-badge {
            background: #10b981;
        }
        .unverified-badge {
            background: #2563EA;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="font-sans bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- Auth Container -->
        <div id="auth-container" class="auth-container flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
                <!-- Logo -->
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto avatar-default rounded-full flex items-center justify-center shadow-md">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 mt-4">Selamat Datang</h1>
                    <p class="text-gray-600 mt-2">Silakan masuk atau daftar untuk melanjutkan</p>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                        <input type="email" id="login-email" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="Masukkan email Anda">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="login-password" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="Masukkan password Anda">
                    </div>
                    <button type="submit" 
                            class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-500 transition-colors">
                        Masuk
                    </button>
                </form>

                <!-- Register Form -->
                <form id="register-form" class="space-y-4 hidden">
                    <div>

<script
  src="https://challenges.cloudflare.com/turnstile/v0/api.js"
  async
  defer
></script>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Nama Lengkap</label>
                        <input type="text" id="register-name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="Masukkan nama lengkap Anda">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                        <input type="email" id="register-email" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="Masukkan email Anda">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="register-password" required minlength="6"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="Buat password minimal 6 karakter">
                    </div>
                    <button type="submit" 
                            class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-500 transition-colors">
                        Daftar
                    </button>
                </form>

                <!-- Toggle Link -->
                <div class="text-center mt-6 pt-4 border-t border-gray-200">
                    <p class="text-gray-600">
                        <span id="toggle-text">Belum punya akun? </span>
                        <button id="toggle-auth" class="text-yellow-600 font-semibold hover:underline">
                            Daftar di sini
                        </button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard-container" class="hidden min-h-screen bg-gray-50">
            <!-- Header -->
            <header class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Dashboard Saya</h1>
                        <button id="logout-btn" 
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm sm:text-base">
                            Keluar
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <!-- Profile Section -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                        <!-- Profile Avatar -->
                        <div class="relative">
                            <div id="profile-avatar" class="w-24 h-24 md:w-32 md:h-32 rounded-full avatar-default flex items-center justify-center text-white text-2xl md:text-4xl font-bold shadow-lg">
                                <!-- Avatar akan diisi oleh JavaScript -->
                            </div>
                        </div>

                        <!-- Profile Info -->
                        <div class="flex-1">
                            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4">Profil Saya</h2>
                            <form id="profile-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                        <input type="text" id="profile-name" 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                               placeholder="Masukkan nama lengkap">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" id="profile-email" disabled
                                               class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-600">
                                    </div>
                                </div>
                                <button type="submit" 
                                        class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    Simpan Perubahan
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- User Data Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- ID Card -->
                    <div class="dashboard-card bg-white rounded-xl shadow-sm p-5">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm2.5 7a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm2.45 4a2.5 2.5 0 10-4.9 0h4.9zM12 9a1 1 0 100 2h3a1 1 0 100-2h-3zm-1 4a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <h3 class="ml-3 text-base font-semibold text-gray-900">ID Akun</h3>
                        </div>
                        <p id="user-id" class="text-lg font-bold text-gray-900 truncate">-</p>
                    </div>

                    <!-- Name Card -->
                    <div class="dashboard-card bg-white rounded-xl shadow-sm p-5">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <h3 class="ml-3 text-base font-semibold text-gray-900">Nama Lengkap</h3>
                        </div>
                        <p id="user-name" class="text-lg font-bold text-gray-900">-</p>
                    </div>

                    <!-- Email Card -->
                    <div class="dashboard-card bg-white rounded-xl shadow-sm p-5">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                                </svg>
                            </div>
                            <h3 class="ml-3 text-base font-semibold text-gray-900">Email</h3>
                        </div>
                        <p id="user-email" class="text-base font-bold text-gray-900 truncate">-</p>
                    </div>

                    <!-- Status Card -->
                    <div class="dashboard-card bg-white rounded-xl shadow-sm p-5">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <h3 class="ml-3 text-base font-semibold text-gray-900">Status Email</h3>
                        </div>
                        <span id="email-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                            -
                        </span>
                    </div>
                </div>

                <!-- Additional Info Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Join Date Card -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Informasi Keanggotaan</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Tanggal Bergabung</span>
                                <span id="join-date" class="font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Terakhir Login</span>
                                <span id="last-login" class="font-medium text-gray-900">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Change Password Card -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Ubah Password</h3>
                        <form id="change-password-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
                                <input type="password" id="new-password" required minlength="6"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Password baru minimal 6 karakter">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Password</label>
                                <input type="password" id="confirm-password" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="Konfirmasi password baru">
                            </div>
                            <button type="submit" 
                                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                Ubah Password
                            </button>
                        </form>
                    </div>
                </div>
            </main>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                <div class="w-6 h-6 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-gray-700">Memproses...</span>
            </div>
        </div>
    </div>

    <script>
        // API
        const supabaseUrl = 'https://vzqrhpcmohxwcschepbt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6cXJocGNtb2h4d2NzY2hlcGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDI5OTUsImV4cCI6MjA3MTY3ODk5NX0.E3eM0o6Yo79xHrrtXs7FKyeBuTPzaH-BVC_KOhR2TF4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleAuth = document.getElementById('toggle-auth');
        const toggleText = document.getElementById('toggle-text');
        const logoutBtn = document.getElementById('logout-btn');
        const profileForm = document.getElementById('profile-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const loadingOverlay = document.getElementById('loading-overlay');

        // State untuk toggle form
        let isLoginFormVisible = true;

        // Toggle between login and register forms - PERBAIKAN BUG
        function setupToggleAuth() {
            toggleAuth.addEventListener('click', () => {
                isLoginFormVisible = !isLoginFormVisible;
                
                if (isLoginFormVisible) {
                    // Tampilkan login form, sembunyikan register form
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    toggleText.textContent = 'Belum punya akun? ';
                    toggleAuth.textContent = 'Daftar di sini';
                } else {
                    // Tampilkan register form, sembunyikan login form
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                    toggleText.textContent = 'Sudah punya akun? ';
                    toggleAuth.textContent = 'Masuk di sini';
                }
            });
        }

        // Login handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;
                
                // Cek apakah email sudah diverifikasi
                if (!data.user.email_confirmed_at) {
                    await supabase.auth.signOut();
                    throw new Error('Email belum diverifikasi. Silakan cek email Anda untuk verifikasi.');
                }
                
                await loadUserData();
                switchToDashboard();
            } catch (error) {
                alert('Login gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Register handler
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            try {
                // Register user
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });

                if (authError) throw authError;

                // Create user profile
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert([
                        { 
                            id: authData.user.id, 
                            full_name: name,
                            email: email,
                            created_at: new Date().toISOString()
                        }
                    ]);

                if (profileError) {
                    console.warn('Error creating profile:', profileError);
                    // Lanjutkan meskipun ada error di profile, karena user sudah terdaftar
                }

                alert('Registrasi berhasil! Silakan Login..');
                // Reset form
                registerForm.reset();
                // Kembali ke form login
                isLoginFormVisible = true;
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                toggleText.textContent = 'Belum punya akun? ';
                toggleAuth.textContent = 'Daftar di sini';
                
            } catch (error) {
                alert('Registrasi gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            showLoading();
            await supabase.auth.signOut();
            switchToAuth();
            hideLoading();
        });

        // Profile update handler
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const name = document.getElementById('profile-name').value;

            try {
                const user = (await supabase.auth.getUser()).data.user;
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        full_name: name,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', user.id);

                if (error) throw error;

                // Update auth metadata juga
                const { error: authError } = await supabase.auth.updateUser({
                    data: { full_name: name }
                });

                if (authError) throw authError;

                alert('Profil berhasil diperbarui!');
                await loadUserData();
            } catch (error) {
                alert('Gagal memperbarui profil: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Change password handler
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                alert('Password dan konfirmasi password tidak cocok!');
                hideLoading();
                return;
            }

            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                alert('Password berhasil diubah!');
                changePasswordForm.reset();
            } catch (error) {
                alert('Gagal mengubah password: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Generate avatar from initials
        function generateAvatar(name) {
            const avatarElement = document.getElementById('profile-avatar');
            if (!name || name.trim() === '') {
                avatarElement.innerHTML = '?';
                return;
            }
            
            const initials = name.split(' ')
                .map(word => word.charAt(0).toUpperCase())
                .join('')
                .substring(0, 2);
            
            avatarElement.innerHTML = initials;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Load user data dengan data yang benar dari database
        async function loadUserData() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                // Get profile data dari tabel profiles
                let { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error) {
                    console.warn('Profile not found, using auth data:', error);
                    // Jika profile tidak ditemukan, gunakan data dari auth
                    profile = {
                        full_name: user.user_metadata?.full_name || '',
                        email: user.email,
                        created_at: user.created_at
                    };
                }

                // Update UI dengan data yang benar
                document.getElementById('user-id').textContent = user.id.substring(0, 12) + '...';
                document.getElementById('user-name').textContent = profile.full_name || 'Tidak ada nama';
                document.getElementById('user-email').textContent = user.email;
                
                document.getElementById('profile-name').value = profile.full_name || '';
                document.getElementById('profile-email').value = user.email;

                // Update status email
                const emailStatus = document.getElementById('email-status');
                if (user.email_confirmed_at) {
                    emailStatus.textContent = 'Terverifikasi';
                    emailStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium verified-badge text-white';
                } else {
                    emailStatus.textContent = 'Belum Terverifikasi';
                    emailStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium unverified-badge text-white';
                }

                // Update tanggal
                document.getElementById('join-date').textContent = formatDate(profile.created_at || user.created_at);
                document.getElementById('last-login').textContent = formatDate(user.last_sign_in_at);

                // Generate avatar
                generateAvatar(profile.full_name);

            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Gagal memuat data pengguna: ' + error.message);
            }
        }

        // Switch to dashboard
        function switchToDashboard() {
            authContainer.classList.add('hidden');
            dashboardContainer.classList.remove('hidden');
        }

        // Switch to auth
        function switchToAuth() {
            authContainer.classList.remove('hidden');
            dashboardContainer.classList.add('hidden');
            // Reset form state
            isLoginFormVisible = true;
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            toggleText.textContent = 'Belum punya akun? ';
            toggleAuth.textContent = 'Daftar di sini';
            // Reset forms
            loginForm.reset();
            registerForm.reset();
        }

        // Loading functions
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Check if user is already logged in
        async function checkAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session && session.user.email_confirmed_at) {
                    await loadUserData();
                    switchToDashboard();
                }
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
            setupToggleAuth();
            checkAuth();
        });
    </script>
</body>
</html>
